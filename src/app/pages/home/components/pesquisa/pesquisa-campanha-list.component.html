<section class="flex flex-col gap-12">
  <div class="flex md:flex-row flex-col items-center gap-4 justify-center mx-32">
    <p-iconField iconPosition="left">
      <p-inputIcon styleClass="pi pi-search" />
      <input
        (ngModelChange)="handleFilter()"
        [(ngModel)]="searchText"
        type="text"
        pInputText
        placeholder="Quem vamos ajudar hoje?"
      />
    </p-iconField>
    <p-dropdown
      (ngModelChange)="handleFilter()"
      [options]="categorys"
      [(ngModel)]="category"
      optionLabel="name"
      placeholder="Escolha uma categoria"
    />
  </div>
  <section class="flex flex-col">
    <section
      class="pb-[64px] pt-4 max-h-[2130px] overflow-x-hidden"
      infiniteScroll
      [infiniteScrollDistance]="3"
      [infiniteScrollThrottle]="500"
      (scrolled)="onScroll()"
      [scrollWindow]="false"
    >
      <section class="flex flex-wrap items-center justify-center gap-8">
        @for (campanha of campanhaSearchResults; track campanha; let index = $index) {
          <app-campanha-card
            (click)="openModalCampanha(campanha)"
            (onReport)="onReportCampanha($event)"
            (onComment)="onCommentCampanha($event)"
            [campanha]="campanha"
          >
          </app-campanha-card>
        } @empty {
          <strong>Nenhum item encontrado.</strong>
        }
      </section>
      @if (showMoreCampanhas) {
        <section class="flex items-center justify-center h-[200px]">
          <span class="flex items-center justify-center gap-2 text-[#fff] bg-[#a8c9ff] rounded-[8px] py-2 px-4 w-fit"
            ><p-progressSpinner
              styleClass="w-[20px] h-[20px] flex"
              strokeWidth="2"
              fill="#a8c9ff"
              animationDuration="1s"
            />Carregando mais campanhas</span
          >
        </section>
      }
    </section>
  </section>
</section>

<p-dialog header="Campanha" [(visible)]="modalCampanha" [style]="{ width: isMobile ? '95dvw' : '60dvw' }">
  <section class="h-fit md:h-[482px] w-full gap-6 flex flex-col-reverse md:flex-row">
    <section class="md:w-[60%] flex flex-col gap-5">
      <div class="flex flex-col gap-1.5">
        <span class="text-sm text-primary">Titulo:</span>
        <span class="w-full p-2 h-fit rounded-lg border-theme border">{{ campanhaSelected?.title }}</span>
      </div>
      <div class="flex flex-col gap-1.5">
        <span class="text-sm text-primary">Categorias:</span>
        <span class="w-full p-2 h-fit rounded-lg border-theme border">{{ categoriesFormatted }}</span>
      </div>

      <!-- Localização da campanha -->
      @if (campanhaSelected?.have_address && hasValidAddress()) {
        <div class="flex flex-col gap-1.5">
          <span class="text-sm text-primary flex items-center justify-between">
            <span class="flex items-center">
              <mat-icon class="text-sm mr-1" svgIcon="map-marker-outline"></mat-icon>
              Localização:
            </span>
            <button
              (click)="openGoogleMaps()"
              class="flex items-center gap-1 px-2 py-1 text-xs bg-green-100 hover:bg-green-200 text-green-700 rounded-md transition-colors duration-200"
              title="Ver no Google Maps"
            >
              <mat-icon class="text-sm" svgIcon="map"></mat-icon>
              Ver no Maps
            </button>
          </span>
          <div class="w-full p-3 rounded-lg border-theme border bg-blue-50">
            <div class="flex flex-col gap-1 text-sm">
              <span class="font-medium text-blue-800">{{ getFormattedAddress() }}</span>
              <span class="text-blue-600">{{ getCityStateFormatted() }}</span>
            </div>
          </div>
        </div>
      }

      <section class="flex gap-3">
        <div class="flex flex-col gap-1.5 w-1/2">
          <span class="text-sm text-primary">Valor solicitador</span>
          <span
            class="w-full font-bold text-[#ec4899] flex items-center justify-center h-[80px] rounded-lg border-theme border"
          >
            {{ campanhaSelected?.value_required | currency: 'BRL' : 'symbol' : '1.2-2' }}
          </span>
        </div>
        <div class="flex flex-col gap-1.5 w-1/2">
          <span class="text-sm text-primary">Valor arrecadado</span>
          <span
            class="w-full font-bold text-[#ec4899] flex items-center justify-center h-[80px] rounded-lg border-theme border"
          >
            {{ campanhaSelected?.value_donated ?? 0 | currency: 'BRL' : 'symbol' : '1.2-2' }}
          </span>
        </div>
      </section>
      <div class="flex flex-col gap-1.5 h-full">
        <span class="text-sm text-primary">Descrição:</span>
        <span class="w-full h-full md:max-h-[155px] p-2 h-fit rounded-lg border-theme border overflow-y-auto">{{
          campanhaSelected?.description
        }}</span>
      </div>
    </section>
    <div class="md:w-[40%] h-[200px] md:h-[482px] relative">
      @if (campanhaSelected?.image?.url) {
        <img
          class="h-[200px] md:h-full w-full rounded-3xl"
          [src]="campanhaSelected?.image?.url"
          alt="Imagem da campanha"
        />
      } @else {
        <div class="h-[200px] md:h-full w-full flex items-center justify-center rounded-3xl bg-[#c8c8c8]">
          <mat-icon style="color: gray" svgIcon="camera-off"></mat-icon>
        </div>
      }
      @if (campanhaSelected?.emergency) {
        <p-tag [rounded]="true" class="absolute left-2.5 bottom-2.5 z-10" value="Urgente" />
      }
    </div>
  </section>
  <section class="flex justify-end mt-4">
    @if (canDonate()) {
      <p-button label="Realizar doação" (onClick)="userSession ? (modalDonate = true) : userNotLogged()" />
    } @else {
      <p-button
        label="Campanha Finalizada"
        [disabled]="true"
        severity="secondary"
        pTooltip="Esta campanha foi finalizada e não aceita mais doações"
      />
    }
  </section>
</p-dialog>

<p-dialog header="Doar" [(visible)]="modalDonate" [style]="{ width: '400px' }" [modal]="true" [dismissableMask]="true">
  <div class="flex flex-col gap-3">
    <label for="valueDonation" class="text-sm font-medium text-gray-600">
      <i class="pi pi-heart text-pink-500 mr-2"></i>
      Qual valor você deseja doar?
    </label>

    <p-inputNumber
      id="valueDonation"
      [(ngModel)]="valueDonation"
      mode="decimal"
      [minFractionDigits]="2"
      [maxFractionDigits]="2"
      inputStyleClass="w-full p-inputtext-sm"
      class="w-full"
      placeholder="Ex: 50,00"
    />
  </div>

  <section class="flex justify-end mt-6">
    <p-button
      [loading]="loading"
      label="Confirmar Doação"
      icon="pi pi-check-circle"
      class="w-full sm:w-auto"
      (onClick)="donate()"
    />
  </section>
</p-dialog>

<app-report-modal
  [visible]="modalReport"
  [campanha]="campanhaSelected"
  (onClose)="modalReport = false"
  [userSession]="userSession"
>
</app-report-modal>

<app-comments-modal
  [visible]="modalComments"
  [campanha]="campanhaSelected"
  (onClose)="modalComments = false"
  [userSession]="userSession"
>
</app-comments-modal>


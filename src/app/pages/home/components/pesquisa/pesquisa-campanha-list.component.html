<section class="flex flex-col gap-12">
  <div class="flex md:flex-row flex-col items-center gap-4 justify-center mx-32">
    <p-iconField iconPosition="left">
      <p-inputIcon styleClass="pi pi-search" />
      <input
        (ngModelChange)="handleFilter()"
        [(ngModel)]="searchText"
        type="text"
        pInputText
        placeholder="Quem vamos ajudar hoje?"
      />
    </p-iconField>
    <p-dropdown
      (ngModelChange)="handleFilter()"
      [options]="categorys"
      [(ngModel)]="category"
      optionLabel="name"
      placeholder="Escolha uma categoria"
    />
  </div>
  <section class="flex flex-col">
    <section
      class="pb-[64px] pt-4 max-h-[2130px] overflow-x-hidden"
      infiniteScroll
      [infiniteScrollDistance]="3"
      [infiniteScrollThrottle]="500"
      (scrolled)="onScroll()"
      [scrollWindow]="false"
    >
      <section class="flex flex-wrap items-center justify-center gap-8">
        @for (campanha of campanhaSearchResults; track campanha; let index = $index) {
          <app-campanha-card
            (click)="openModalCampanha(campanha)"
            (onReport)="onReportCampanha($event)"
            (onComment)="onCommentCampanha($event)"
            [campanha]="campanha"
          >
          </app-campanha-card>
        } @empty {
          <strong>Nenhum item encontrado.</strong>
        }
      </section>
      @if (showMoreCampanhas) {
        <section class="flex items-center justify-center h-[200px]">
          <span class="flex items-center justify-center gap-2 text-[#fff] bg-[#a8c9ff] rounded-[8px] py-2 px-4 w-fit"
            ><p-progressSpinner
              styleClass="w-[20px] h-[20px] flex"
              strokeWidth="2"
              fill="#a8c9ff"
              animationDuration="1s"
            />Carregando mais campanhas</span
          >
        </section>
      }
    </section>
  </section>
</section>

<p-dialog header="Campanha" [(visible)]="modalCampanha" [style]="{ width: isMobile ? '95dvw' : '60dvw' }">
  <section class="h-fit md:h-[482px] w-full gap-6 flex flex-col-reverse md:flex-row">
    <section class="md:w-[60%] flex flex-col gap-5">
      <div class="flex flex-col gap-1.5">
        <span class="text-sm text-primary">Titulo:</span>
        <span class="w-full p-2 h-fit rounded-lg border-theme border">{{ campanhaSelected?.title }}</span>
      </div>
      <div class="flex flex-col gap-1.5">
        <span class="text-sm text-primary">Categorias:</span>
        <span class="w-full p-2 h-fit rounded-lg border-theme border">{{ categoriesFormatted }}</span>
      </div>

      @if (campanhaSelected?.have_address && hasValidAddress()) {
        <div class="flex flex-col gap-1.5">
          <span class="text-sm text-primary flex items-center justify-between">
            <span class="flex items-center">
              <mat-icon class="text-sm mr-1" svgIcon="map-marker-outline"></mat-icon>
              Localiza√ß√£o:
            </span>
            <button
              (click)="openGoogleMaps()"
              class="flex items-center gap-1 px-2 py-1 text-xs bg-green-100 hover:bg-green-200 text-green-700 rounded-md transition-colors duration-200"
              title="Ver no Google Maps"
            >
              <mat-icon class="text-sm" svgIcon="map"></mat-icon>
              Ver no Maps
            </button>
          </span>
          <div class="w-full p-3 rounded-lg border-theme border bg-blue-50">
            <div class="flex flex-col gap-1 text-sm">
              <span class="font-medium text-blue-800">{{ getFormattedAddress() }}</span>
              <span class="text-blue-600">{{ getCityStateFormatted() }}</span>
            </div>
          </div>
        </div>
      }

      <section class="flex gap-3">
        <div class="flex flex-col gap-1.5 w-1/2">
          <span class="text-sm text-primary">Valor solicitador</span>
          <span
            class="w-full font-bold text-[#ec4899] flex items-center justify-center h-[80px] rounded-lg border-theme border"
          >
            {{ campanhaSelected?.value_required | currency: 'BRL' : 'symbol' : '1.2-2' }}
          </span>
        </div>
        <div class="flex flex-col gap-1.5 w-1/2">
          <span class="text-sm text-primary">Valor arrecadado</span>
          <span
            class="w-full font-bold text-[#ec4899] flex items-center justify-center h-[80px] rounded-lg border-theme border"
          >
            {{ campanhaSelected?.value_donated ?? 0 | currency: 'BRL' : 'symbol' : '1.2-2' }}
          </span>
        </div>
      </section>
      <div class="flex flex-col gap-1.5 h-full">
        <span class="text-sm text-primary">Descri√ß√£o:</span>
        <span class="w-full h-full md:max-h-[155px] p-2 h-fit rounded-lg border-theme border overflow-y-auto">{{
          campanhaSelected?.description
        }}</span>
      </div>
    </section>
    <div class="md:w-[40%] h-[200px] md:h-[482px] relative">
      @if (campanhaSelected?.image?.url) {
        <img
          class="h-[200px] md:h-full w-full rounded-3xl"
          [src]="campanhaSelected?.image?.url"
          alt="Imagem da campanha"
        />
      } @else {
        <div class="h-[200px] md:h-full w-full flex items-center justify-center rounded-3xl bg-[#c8c8c8]">
          <mat-icon style="color: gray" svgIcon="camera-off"></mat-icon>
        </div>
      }
      @if (campanhaSelected?.emergency) {
        <p-tag [rounded]="true" class="absolute left-2.5 bottom-2.5 z-10" value="Urgente" />
      }
    </div>
  </section>
  <section class="flex justify-end mt-4">
    @if (canDonate()) {
      <p-button label="Realizar doa√ß√£o" (onClick)="userSession ? (modalDonate = true) : userNotLogged()" />
    } @else {
      <p-button
        label="Campanha Finalizada"
        [disabled]="true"
        severity="secondary"
        pTooltip="Esta campanha foi finalizada e n√£o aceita mais doa√ß√µes"
      />
    }
  </section>
</p-dialog>

<p-dialog
  [(visible)]="modalDonate"
  [style]="{ width: isMobile ? '95dvw' : '500px' }"
  [modal]="true"
  [dismissableMask]="true"
  [showHeader]="false"
  styleClass="donation-modal"
>
  <div class="flex flex-col gap-6 p-2">
    <div class="text-center">
      <div class="flex justify-center mb-4">
        <div
          class="w-16 h-16 bg-gradient-to-br from-pink-100 to-pink-200 dark:from-pink-900/30 dark:to-pink-800/30 rounded-full flex items-center justify-center"
        >
          <i class="pi pi-heart text-3xl text-pink-500 dark:text-pink-400"></i>
        </div>
      </div>
      <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-2">Fazer uma Doa√ß√£o</h2>
      <p class="text-sm text-gray-500 dark:text-gray-400">Sua contribui√ß√£o faz a diferen√ßa! üíö</p>
    </div>

    @if (campanhaSelected) {
      <div
        class="bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-4 border border-blue-100 dark:border-blue-800/30"
      >
        <div class="flex items-start gap-3">
          @if (campanhaSelected.image) {
            <img [src]="campanhaSelected.image.url" alt="Campanha" class="w-16 h-16 rounded-lg object-cover" />
          }
          <div class="flex-1 min-w-0">
            <p class="font-semibold text-gray-800 dark:text-gray-100 text-sm mb-1 truncate">
              {{ campanhaSelected.title }}
            </p>
            <div class="flex flex-col gap-1 text-xs text-gray-600 dark:text-gray-400">
              <div class="flex items-center gap-2">
                <span class="font-medium">Meta:</span>
                <span>{{ campanhaSelected.value_required | currency: 'BRL' : 'symbol' : '1.2-2' }}</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="font-medium">Arrecadado:</span>
                <span class="text-green-600 dark:text-green-400 font-semibold">{{
                  campanhaSelected.value_donated || 0 | currency: 'BRL' : 'symbol' : '1.2-2'
                }}</span>
              </div>
            </div>
            <div class="mt-2 w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5">
              <div
                class="bg-gradient-to-r from-pink-500 to-purple-500 h-1.5 rounded-full transition-all duration-300"
                [style.width.%]="getProgress(campanhaSelected)"
              ></div>
            </div>
          </div>
        </div>
      </div>
    }

    <div>
      <span class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 block">Valores sugeridos:</span>
      <div class="grid grid-cols-3 gap-2 container-buttons">
        <p-button
          (onClick)="valueDonation = 10"
          label="R$ 10"
          [outlined]="valueDonation !== 10"
          [severity]="valueDonation === 10 ? 'help' : 'secondary'"
          styleClass="text-sm font-medium py-3 w-full"
        />
        <p-button
          (onClick)="valueDonation = 25"
          label="R$ 25"
          [outlined]="valueDonation !== 25"
          [severity]="valueDonation === 25 ? 'help' : 'secondary'"
          styleClass="text-sm font-medium py-3 w-full"
        />
        <p-button
          (onClick)="valueDonation = 50"
          label="R$ 50"
          [outlined]="valueDonation !== 50"
          [severity]="valueDonation === 50 ? 'help' : 'secondary'"
          styleClass="text-sm font-medium py-3 w-full"
        />
        <p-button
          (onClick)="valueDonation = 100"
          label="R$ 100"
          [outlined]="valueDonation !== 100"
          [severity]="valueDonation === 100 ? 'help' : 'secondary'"
          styleClass="text-sm font-medium py-3 w-full"
        />
        <p-button
          (onClick)="valueDonation = 200"
          label="R$ 200"
          [outlined]="valueDonation !== 200"
          [severity]="valueDonation === 200 ? 'help' : 'secondary'"
          styleClass="text-sm font-medium py-3 w-full"
        />
        <p-button
          (onClick)="valueDonation = 500"
          label="R$ 500"
          [outlined]="valueDonation !== 500"
          [severity]="valueDonation === 500 ? 'help' : 'secondary'"
          styleClass="text-sm font-medium py-3 w-full"
        />
      </div>
    </div>

    <div>
      <label for="valueDonation" class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2 block">
        Ou insira outro valor:
      </label>
      <div class="relative">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 font-medium">R$</span>
        <p-inputNumber
          id="valueDonation"
          [(ngModel)]="valueDonation"
          mode="decimal"
          [minFractionDigits]="2"
          [maxFractionDigits]="2"
          [min]="1"
          inputStyleClass="w-full pl-10 py-3 text-lg font-semibold"
          class="w-full"
          placeholder="0,00"
        />
      </div>
      @if (valueDonation && valueDonation < 1) {
        <p class="text-xs text-red-500 dark:text-red-400 mt-1">O valor m√≠nimo para doa√ß√£o √© R$ 1,00</p>
      }
    </div>

    @if (valueDonation && valueDonation >= 1) {
      <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800/30 rounded-lg p-3">
        <p class="text-sm text-green-700 dark:text-green-400 text-center">
          <i class="pi pi-check-circle mr-1"></i>
          Voc√™ est√° prestes a doar <strong>{{ valueDonation | currency: 'BRL' : 'symbol' : '1.2-2' }}</strong
          >!
        </p>
      </div>
    }

    <div class="flex gap-3 justify-between">
      <p-button
        (onClick)="modalDonate = false"
        label="Cancelar"
        [outlined]="true"
        severity="secondary"
        styleClass="flex-1"
      />
      <p-button
        (onClick)="donate()"
        [disabled]="!valueDonation || valueDonation < 1 || loading"
        [loading]="loading"
        [label]="loading ? 'Processando...' : 'Confirmar Doa√ß√£o'"
        icon="pi pi-heart"
        severity="help"
        styleClass="flex-1"
      />
    </div>

    <p class="text-xs text-gray-500 dark:text-gray-400 text-center">
      <i class="pi pi-lock mr-1"></i>
      Transa√ß√£o segura e protegida
    </p>
  </div>
</p-dialog>

<app-report-modal
  [visible]="modalReport"
  [campanha]="campanhaSelected"
  (onClose)="modalReport = false"
  [userSession]="userSession"
>
</app-report-modal>

<app-comments-modal
  [visible]="modalComments"
  [campanha]="campanhaSelected"
  (onClose)="modalComments = false"
  [userSession]="userSession"
>
</app-comments-modal>


<ng-template #header pTemplate="header" let-onClick="onClick" let-index="index">
  <section class="flex gap-3">
    <div
      class="w-12 h-12 flex items-center justify-center rounded-full transition-colors"
      [ngClass]="{
        'text-white bg-blue-600': activeStep === index,
        'text-secondary bg-surface border border-theme': activeStep !== index,
      }"
    >
      <mat-icon svgIcon="map"></mat-icon>
    </div>
    @if (activeStep === index) {
      <div class="flex flex-col justify-center">
        <span class="text-xs text-blue-600 font-bold"> Passo {{ index + 1 }}/{{ totalSteps }} </span>
        <span class="text-primary">Informando endereço</span>
      </div>
    }
  </section>
</ng-template>

<ng-template
  #content
  pTemplate="content"
  let-prevCallback="prevCallback"
  let-nextCallback="nextCallback"
  let-index="index"
>
  <form *ngIf="stepEnderecoForm" [formGroup]="stepEnderecoForm" class="flex flex-col min-h-[600px] p-6 gap-6 bg-card">
    <div class="flex flex-col gap-2">
      <h1 class="text-xl text-primary font-bold">Endereço</h1>
      <span class="text-secondary max-w-[400px]">Preencha o local no qual a campanha será realizada</span>
    </div>

    <div class="flex gap-6 h-fit">
      <section class="w-1/2 flex flex-col gap-4">
        <div class="flex flex-col gap-1.5">
          <label for="address_zipcode" class="text-sm text-secondary font-medium">CEP</label>
          <p-inputMask
            mask="99999-999"
            id="address_zipcode"
            formControlName="address_zipcode"
            (onBlur)="address_zipcode?.invalid && address_zipcode?.markAsDirty()"
            placeholder="12345-678"
          ></p-inputMask>

          <div
            class="flex align-items-end text-xs"
            [ngClass]="
              address_zipcode?.invalid && (address_zipcode?.dirty || address_zipcode?.touched)
                ? 'justify-between'
                : 'justify-end'
            "
          >
            <span
              [ngClass]="
                address_zipcode?.invalid && (address_zipcode?.dirty || address_zipcode?.touched)
                  ? 'visible text-red-600'
                  : 'invisible text-red-600'
              "
            >
              <ng-container *ngIf="address_zipcode?.errors as errors">
                <ng-container *ngIf="errors['required']">CEP é obrigatório.</ng-container>
                <ng-container *ngIf="errors['pattern']">CEP deve ter o formato 99999-999.</ng-container>
              </ng-container>
            </span>
          </div>
        </div>

        <div class="flex flex-col gap-1.5">
          <label for="address_street" class="text-sm text-secondary font-medium">Rua</label>
          <input
            type="text"
            pInputText
            id="address_street"
            formControlName="address_street"
            (blur)="address_street?.invalid && address_street?.markAsDirty()"
            placeholder="Rua das Flores"
          />

          <div
            class="flex align-items-end text-xs"
            [ngClass]="
              address_street?.invalid && (address_street?.dirty || address_street?.touched)
                ? 'justify-between'
                : 'justify-end'
            "
          >
            <span
              [ngClass]="
                address_street?.invalid && (address_street?.dirty || address_street?.touched)
                  ? 'visible text-red-600'
                  : 'invisible text-red-600'
              "
            >
              <ng-container *ngIf="address_street?.errors as errors">
                <ng-container *ngIf="errors['required']">Rua é obrigatória.</ng-container>
                <ng-container *ngIf="errors['minlength']">Mínimo de 3 caracteres.</ng-container>
                <ng-container *ngIf="errors['maxlength']">Máximo de 100 caracteres.</ng-container>
              </ng-container>
            </span>
          </div>
        </div>

        <div class="flex gap-2">
          <div class="flex flex-col gap-1.5 w-1/3">
            <label for="address_number" class="text-sm text-secondary font-medium">Número</label>
            <input
              type="text"
              pInputText
              id="address_number"
              formControlName="address_number"
              (blur)="address_number?.invalid && address_number?.markAsDirty()"
              placeholder="123"
            />

            <div
              class="flex align-items-end text-xs"
              [ngClass]="
                address_number?.invalid && (address_number?.dirty || address_number?.touched)
                  ? 'justify-between'
                  : 'justify-end'
              "
            >
              <span
                [ngClass]="
                  address_number?.invalid && (address_number?.dirty || address_number?.touched)
                    ? 'visible text-red-600'
                    : 'invisible text-red-600'
                "
              >
                <ng-container *ngIf="address_number?.errors as errors">
                  <ng-container *ngIf="errors['required']">Número é obrigatório.</ng-container>
                  <ng-container *ngIf="errors['minlength']">Mínimo de 1 caractere.</ng-container>
                  <ng-container *ngIf="errors['maxlength']">Máximo de 10 caracteres.</ng-container>
                </ng-container>
              </span>
            </div>
          </div>

          <div class="flex flex-col gap-1.5 w-2/3">
            <label for="address_complement" class="text-sm text-secondary font-medium">Complemento</label>
            <input
              type="text"
              pInputText
              id="address_complement"
              formControlName="address_complement"
              (blur)="address_complement?.invalid && address_complement?.markAsDirty()"
              placeholder="Apto 123"
            />

            <div
              class="flex align-items-end text-xs"
              [ngClass]="
                address_complement?.invalid && (address_complement?.dirty || address_complement?.touched)
                  ? 'justify-between'
                  : 'justify-end'
              "
            >
              <span
                [ngClass]="
                  address_complement?.invalid && (address_complement?.dirty || address_complement?.touched)
                    ? 'visible text-red-600'
                    : 'invisible text-red-600'
                "
              >
                <ng-container *ngIf="address_complement?.errors as errors">
                  <ng-container *ngIf="errors['maxlength']">Máximo de 50 caracteres.</ng-container>
                </ng-container>
              </span>
            </div>
          </div>
        </div>

        <div class="flex flex-col gap-1.5">
          <label for="address_neighborhood" class="text-sm text-secondary font-medium">Bairro</label>
          <input
            type="text"
            pInputText
            id="address_neighborhood"
            formControlName="address_neighborhood"
            (blur)="address_neighborhood?.invalid && address_neighborhood?.markAsDirty()"
            placeholder="Centro"
          />

          <div
            class="flex align-items-end text-xs"
            [ngClass]="
              address_neighborhood?.invalid && (address_neighborhood?.dirty || address_neighborhood?.touched)
                ? 'justify-between'
                : 'justify-end'
            "
          >
            <span
              [ngClass]="
                address_neighborhood?.invalid && (address_neighborhood?.dirty || address_neighborhood?.touched)
                  ? 'visible text-red-600'
                  : 'invisible text-red-600'
              "
            >
              <ng-container *ngIf="address_neighborhood?.errors as errors">
                <ng-container *ngIf="errors['required']">Bairro é obrigatório.</ng-container>
                <ng-container *ngIf="errors['minlength']">Mínimo de 2 caracteres.</ng-container>
                <ng-container *ngIf="errors['maxlength']">Máximo de 50 caracteres.</ng-container>
              </ng-container>
            </span>
          </div>
        </div>

        <div class="flex gap-2">
          <div class="flex flex-col gap-1.5 w-2/3">
            <label for="address_city" class="text-sm text-secondary font-medium">Cidade</label>
            <input
              type="text"
              pInputText
              id="address_city"
              formControlName="address_city"
              (blur)="address_city?.invalid && address_city?.markAsDirty()"
              placeholder="São Paulo"
            />

            <div
              class="flex align-items-end text-xs"
              [ngClass]="
                address_city?.invalid && (address_city?.dirty || address_city?.touched)
                  ? 'justify-between'
                  : 'justify-end'
              "
            >
              <span
                [ngClass]="
                  address_city?.invalid && (address_city?.dirty || address_city?.touched)
                    ? 'visible text-red-600'
                    : 'invisible text-red-600'
                "
              >
                <ng-container *ngIf="address_city?.errors as errors">
                  <ng-container *ngIf="errors['required']">Cidade é obrigatória.</ng-container>
                  <ng-container *ngIf="errors['minlength']">Mínimo de 2 caracteres.</ng-container>
                  <ng-container *ngIf="errors['maxlength']">Máximo de 50 caracteres.</ng-container>
                </ng-container>
              </span>
            </div>
          </div>

          <div class="flex flex-col gap-1.5 w-1/3">
            <label for="address_state" class="text-sm text-secondary font-medium">Estado</label>
            <input
              type="text"
              pInputText
              id="address_state"
              formControlName="address_state"
              (blur)="address_state?.invalid && address_state?.markAsDirty()"
              placeholder="SP"
            />

            <div
              class="flex align-items-end text-xs"
              [ngClass]="
                address_state?.invalid && (address_state?.dirty || address_state?.touched)
                  ? 'justify-between'
                  : 'justify-end'
              "
            >
              <span
                [ngClass]="
                  address_state?.invalid && (address_state?.dirty || address_state?.touched)
                    ? 'visible text-red-600'
                    : 'invisible text-red-600'
                "
              >
                <ng-container *ngIf="address_state?.errors as errors">
                  <ng-container *ngIf="errors['required']">Estado é obrigatório.</ng-container>
                  <ng-container *ngIf="errors['minlength']">Mínimo de 2 caracteres.</ng-container>
                  <ng-container *ngIf="errors['maxlength']">Máximo de 50 caracteres.</ng-container>
                </ng-container>
              </span>
            </div>
          </div>
        </div>
      </section>

      <section class="w-1/2 flex flex-col gap-2">
        <div class="flex justify-between items-center">
          <span class="text-sm text-secondary font-medium">Localização no Mapa</span>
          <div class="flex gap-2">
            <button
              type="button"
              (click)="updateMap()"
              class="text-xs text-blue-600 hover:underline flex items-center gap-1 bg-transparent border-none cursor-pointer"
            >
              <mat-icon class="text-sm" svgIcon="refresh"></mat-icon>
              Atualizar Mapa
            </button>
            @if (getGoogleMapsLink()) {
              <a
                [href]="getGoogleMapsLink()"
                target="_blank"
                class="text-xs text-blue-600 hover:underline flex items-center gap-1"
              >
                <mat-icon class="text-sm" svgIcon="open-in-new"></mat-icon>
                Abrir no Google Maps
              </a>
            }
          </div>
        </div>
        <div
          class="h-full border border-theme rounded-lg overflow-hidden bg-surface flex items-center justify-center relative min-h-[400px]"
        >
          @if (mapUrl) {
            <iframe
              [src]="mapUrl"
              width="100%"
              height="100%"
              style="border: 0; min-height: 400px"
              allowfullscreen=""
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
              title="Localização do endereço"
              class="rounded-lg"
            >
            </iframe>
          } @else {
            <div class="text-center text-secondary p-8">
              <mat-icon class="text-5xl mb-3 text-secondary" svgIcon="map-marker-outline"></mat-icon>
              <p class="font-medium text-base mb-1 text-primary">Mapa não disponível</p>
              <p class="text-sm text-secondary">Preencha o endereço para visualizar o mapa</p>
              <p class="text-xs text-secondary mt-2">O mapa será atualizado automaticamente ao preencher o CEP</p>
            </div>
          }
        </div>
      </section>
    </div>

    <section class="flex justify-between items-center pt-4 border-t border-theme">
      <p-button label="Cancelar" severity="secondary" [outlined]="true" (onClick)="onCancel.emit()" />
      <div class="flex gap-2">
        <p-button
          label="Voltar"
          severity="secondary"
          [outlined]="true"
          icon="pi pi-arrow-left"
          (onClick)="prevCallback.emit()"
          [disabled]="false"
        />
        <p-button
          label="Próximo"
          icon="pi pi-arrow-right"
          iconPos="right"
          (onClick)="nextCallback.emit()"
          [disabled]="stepEnderecoForm.invalid"
        />
      </div>
    </section>
  </form>
</ng-template>

